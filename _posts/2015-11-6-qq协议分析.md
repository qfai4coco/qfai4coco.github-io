#QQ协议分析

[another source](
http://wenku.baidu.com/link?url=wM3vRj6QZFbN2XCGjSUZGfxAKuMNPdzka05V7BVIKwRCSXYDsZSGm8FCKMqIs69C_3CP6uQBHnU6XE5PKIAOoL97sHYcfwFPz4byxxkj8oy
)

QQ默认是UDP连接
传文件时候呢？TCP+HTTP

>QQ程序运行后会做以下的事
1，向服务器请求一个登陆令牌。
      成功的话，服务器返回一个令牌。
2，发出登陆请求（用到前面获得的令牌）
      登陆成功
      ……
      
  
 qq封包一般由包头，包体，包尾组成。也有些包没有包尾。
根据<LumaQQ开发者参考手册>qq基本输入包格式是这样的。

#####05系列的输入包基类

1. 包头标识，1字节
2. source，2字节
3. 包长度，2字节
4. 包命令，2字节
5. 包序号，2字节
6. 用户QQ号，4字节
7. 包体
8. 包尾，1字节

我们来安号入座。

#####05系列的输入包基类

1. 包头标识，0x02 //说明是基本包
2. source，0x 0e1b   //qq版本
3. 包长度，无对应 //可能是使用的是UDP所以不需要长度信息
4. 包命令，0x0062 //说明是一个请求登陆包，我这样想
5. 包序号，0x6339 //循环增加
6. 用户QQ号，0x15846e8f   //用windows附件里的计算器转化成10进制，果然是偶的QQ号！！
7. 包体 0x00           //请求登陆包的包体就是0x00，其他的包会大一点，而且可能会加密，
8. 包尾，0x03      

---
* ******** 普通消息，消息类型为0x0009或者0x000A *********
* 头部
* --------- 加密开始（会话密钥）----------
* 发送者QQ号，4字节
* 接收者QQ号，4字节
* 包序号（并非我们发送时候的序号，因为这个是4字节，可能是服务器端得总序号）
* 发送者IP，如果是服务器转发的，那么ip就是服务器ip， 4字节
* 发送者端口，如果是服务器转发的，那么就是服务器的端口，2字节
* 消息类型，2字节，0x0009或者0x000A
* 发送者QQ版本，2字节
* 发送者的QQ号，4字节
* 接受者的QQ号，4字节
* md5处理的发送方的uid和session key，16字节
* 普通消息类型，比如是文本消息还是其他什么消息，2字节
* 会话ID，2字节，如果是一个操作需要发送多个包才能完成，则这个id必须一致
* 发送时间，4字节
* 发送者头像，2字节
* 是否有字体属性，4字节，有一般是0x00000001
* 消息的分片数，1字节
* 分片序号，1字节，从0开始
* 消息id，2字节，同一条消息的不同分片id相同
* 消息回复类型，这里的类型表示是正常回复还是自动回复之类的信息， 1字节
* 消息正文，长度 = 剩余字节数 - 包尾字体属性长度
* 字体属性，和SendIMPacket中的相同
* --------- 加密结束 ---------
* 尾部



---

*   发送消息的包，格式为 
*   1.   头部   7个字节(1.   包头标志，1字节，0x02,2.   客户端版本代码，2字节,3.   命令，2字   节,4.   包序号,   2字节) 
*   2.   发送者QQ号，4个字节 
*   3.   接收者的QQ号，4个字节 
*   4.   发送者QQ版本，2字节 
*   5.   发送者QQ号，4字节 
*   6.   接收者QQ号，4个字节（奇怪，为什么要搞两个在里面） 
*   7.   发送者QQ号和session   key合在一起用md5处理一次的结果，16字节 
*   8.   消息类型，2字节（41） 
*   9.   会话ID，2字节，如果是一个操作需要发送多个包才能完成，则这个id必须一致 
*   10.   发送时间，4字节 
*   11.   发送者头像，2字节 
*   12.   字体信息，4字节，设成0x00000001吧，不懂具体意思 
*   13.   消息分片数，1字节，如果消息比较长，这里要置一个分片值，QQ缺省是700字节一个分片，这个700字节是纯消息， 
*   不包含其他部分 
*   14.   分片序号，1字节，从0开始（55） 
*   15.   消息的id，2字节，同一条消息的不同分片id相同 
*   16.   消息方式，是发送的，还是自动回复的，1字节 
*   17.   消息内容，最后一个分片的结尾需要追加一个空格。 
*   Note:   结尾处的空格是必须的，如果不追加空格，会导致有些缺省表情显示为乱码 
*   18.   消息的尾部，包含一些消息的参数，比如字体颜色啦，等等等等，顺序是 
*   1.   字体修饰属性，bold，italic之类的，2字节，已知的位是 
*   i.   bit0-bit4用来表示字体大小，所以最大是32 
*   ii.   bit5表示是否bold 
*   iii.   bit6表示是否italic 
*   iv.   bit7表示是否underline 
*   2.   颜色Red，1字节 
*   3.   颜色Green，1字节 
*   4.   颜色Blue，1字节 
*   5.   1个未知字节，置0先 
*   6.   消息编码，2字节，0x8602为GB，0x0000为EN，其他未知，好像可以自定义，因为服务器好像不干涉 
*   7.   字体名，比如0xcb,   0xce,   0xcc,   0xe5表示宋体 
*   19.   1字节，表示18和19部分的字节长度 
*   20.   包尾部 
---
*   请求传送文件的包，这是这个包的另一种用法，其格式为 
*   1   -   14.   1到14部分均与发送消息包相同，只有第8部分不同，对于UDP的请求，8部分是0x0035，对于TCP，是0x0001 
*   15   -   17.   怀疑也和发送消息包相同，但是在这种情况中，这部分没有使用，为全0，一共11个0字节 
*   18.   传输类型，1字节，表示是传文件还是传表情 
*   19.   连接方式字节，UDP是0，   TCP是3 
*   20.   4个字节的发送者外部ip地址（也就是可能为代理地址） 
*   21.   2个字节的发送者端口 
*   22.   2个字节的端口，第一个监听端口，TCP没有这个部分 
*   23.   4个字节的地址，真实IP 
*   24.   2个字节的端口，第二个而监听端口 
*   25.   空格符号做为上述信息的结束，一个字节，0x20 
*   26.   分隔符0x1F 
*   27.   要传送的文件名 
*   28.   分隔符0x1F 
*   29.   字节数的字符串形式后跟 "   字节 "，比如文件大小3字节的话，就是 "3   字节 "这个字符串的编码形式 
*   30.   尾部 
 ---
*   同意传送文件的包，格式为 
*   1   -   24.   除了8部分，其他均与发送消息包相同。对于UDP的情况，8部分是0x0037，TCP是0x0003。 
*   UDP时，最后的本地ip和端口都是0；TCP时没有22部分 
*   25.   尾部 
* 
*   拒绝接收文件的包，格式为 
*   1   -   19.   除了8部分，均与同意传送文件包相同。对于UDP的情况，8部分是0x0039，对于TCP，是0x0005 
*   20.   尾部 
* 
*   通知我的IP信息，格式为 
*   1   -   24.   除了8部分，均与请求传送文件包相同。8部分是0x003B 
*   25.   尾部 
* 
*   取消传送文件，格式为 
*   1   -   18.   除了8部分，均与请求传送文件包相同。8部分是0x0049 
*   19.   尾部 
* 
*   要求别人主动连接我的包，格式为 
*   1   -   18.   除了8部分，均与请求传送文件包相同。8部分是0x003F 
*   19.   尾部

---
QQ的加密解密用的是TEA算法(puzzlebird的说法)，不详细解释了。QQ的包一般都是加密的（包头包尾除外），但是有个别包是不加密的，以后 如果不做特别说明，则默认这个包是需要加密的。此外，用什么密钥加密也有不同，不过基本上都是用会话密钥加密，以后如果不做特殊说明，表示是用会话密钥加 密。这里要注意一下，有时候你收到的包可能不是用会话密钥加密的，比如离线的消息。你人都不在了，哪里来的会话密钥？所以服务器在你下次登录的时候，会把 你还没收到过的消息用密码密钥加密再传给你。这是一种特殊的情况，要分清楚。

UDP和TCP

QQ支持UDP和TCP登录（如果使用HTTP代理，则相当于TCP登录），UDP登录没有什么好说的，TCP登录时，不管什么包的开头两字节都是包长度，这个长度包括了这两个字节。

包头包尾

QQ协议有多种包头，每种包头都分别代表了一类用途的包，但是不是所有的包都有包尾，以下是一些存在的包头包尾格式参考

包头 包尾 包头之后的固定格式 说明

0x00 无 发送方QQ版本，或者是服务器版本，2字节

随机密钥，1字节，如果这个字节是0x23，那么密钥就是0x23232323，这个密钥用来加密发送者和接受者的QQ号。加密算法: QQ号取反再与密钥异或

发送者QQ号的加密形式，4字节

接受者QQ号的加密形式，4字节

0x00系列的包，用在文件传输过程中，传递控制信息。也会出现在点对点通信中。

0x02 0x03 源标志, 2字节，表示了这个包从何处来，主要用来标识客户端版本，如果其标识

的是服务器，这个字段的具体用处还不清楚

包命令, 2字节

包序号, 2字节, 原则是保证短期内这个序号不要重复就可以，一般我们处理的时候都是递增，到最大再归0

0x02系列包主要完成一些基本任务，基本上处理了这个系列的包，QQ的功能就差不多了。 0x03 无 格式同第一行 0x03系列的包，用在文件传输过程中，传递数据信息

0x04 0x03 客户端版本号，2字节

整个的包长，2字节

序号，2字节

我的QQ号，4字节

未知的8字节

0x04系列的包，用在文件传输过程中，如果使用服务器中转模式传送文件，则用到这些包 0x06 未知 未知 还没怎么研究过这种包是干什么的

请求登录令牌

登录QQ，要发的第一个包就是Request Login Token Packet。这个包会向服务器请求一个24字节大小的令牌（也不一定是24，只能说目前是24字节），然后在接下来的登录中，没有这个令牌，你是登录不 了的。这个令牌是在服务器端生成的，具体的生成算法我们当然还无从得知，但是它肯定是参考了你的IP，你的端口，还有你的其他什么信息生成这个令牌的。因 为你把在A机器上得到的令牌用到B机器上，你就会登录不了，如果你把A机器上的IP给改了，你照样也登录不了。

请求包格式

头部

未知的1字节，0x00

尾部

Note: 此包不加密

回复包格式

头部

回复码，1字节，0x00表示成功

登录令牌长度，1字节

登录令牌

尾部

Note: 此包不加密

成功时

操作成功时，核心层会触发QQ_GET_LOGIN_TOKEN_SUCCESS事件，这个事件携带的包是RequestLoginTokenReplyPacket，可用的字段如下:

replyCode: byte，回复码

登录

QQ登录目前有多种模式，比如普通QQ号，电子邮件登录，绑定手机号登录，还有什么普通模式，TM模式。目前我们只支持普通模式和QQ号登录。

请求包格式

头部

初始密钥，16字节

用户的密码密钥加密一个空串得到的16字节

36字节的固定内容，未知含义

登录状态，隐身登录还是什么，1字节

16字节固定内容，未知含义

登录令牌长度，1字节

登录令牌

登录模式，1字节，目前只支持普通模式

未知1字节，0x40

后面段的个数，1字节，1个段9字节(猜测)

段，每次基本都是固定内容，未知含义

长度不足则全部填0直到符合登录包长度，UDP模式登录请求包长度为416字节 尾部

Note: 此包使用初始密钥加密，注意头部之后就是初始密钥，初始密钥是不加密的。

说明

初始密钥在2004以前用的是一个固定值: 16个0x01字节。2004之后，采用随机密钥 密码密钥是通过对用户的密码进行2次MD5生成的

密码密钥加密一个空串是干什么呢？主要是服务器用来验证密码的，如果服务器能用密码密钥解开这16个字节，那么它就认为密码是正确的。在这里，我们不一定非要加密一个空串，其实任意字符串都可以，但是你要保证密文只有16个字节。

登录请求包的固定内容，含义是未知的，而且，也不能说内容是固定的，即使我们把这些字段全部替换成0，依然能够登录

回复包格式

回复包可能有多种情况，包体的第一个字节是回复码，可能的取值如下：

QQ_LOGIN_REPLY_OK: 登录成功

QQ_LOGIN_REPLY_REDIRECT: 重定向

QQ_LOGIN_REPLY_PASSWORD_ERROR: 密码错误

QQ_LOGIN_REPLY_OK：

头部

回复码，1字节

会话密钥，16字节

用户的QQ号，4字节

用户的IP，4字节

用户的端口，2字节

服务器的IP，4字节

服务器的端口，2字节

本次登录时间，4字节

未知的26字节

未知服务器1的IP，服务器的作用未知，4字节

未知服务器1的端口，2字节

未知服务器2的IP，4字节

未知服务器2的端口，2字节

2个未知字节

2个未知字节

Client Key, 32字节

12个未知字节

上次登录时的IP，4字节

上次登录时的时间，4字节

8个未知字节

尾部

QQ_LOGIN_REPLY_REDIRECT：

头部

回复码，1字节

用户QQ号，4字节

重定向的服务器IP，4字节

重定向的服务器端口，2字节

尾部

QQ_LOGIN_REPLY_PASSWORD_ERROR:

头部

回复码，1字节

错误消息字符串

尾部

Note: 登录回复包使用密码密钥加密，或者使用初始密钥加密，在处理时，应该先尝试使用密码密钥解密，如果失败，则再用初始密钥解密。为什么要这样呢，因为你可能密码输入错误，这样的话服务器用密码密钥加密的包你就解密不了了，所以会用初始密钥加密。

说明

时间都是4个字节，其表示从1970-1-1开始的毫秒数再除以1000

Client Key是用在访问一些网络服务时，比如QQ秀，通过Client Key，TX可以直接定位到你的QQ秀页面，还有什么QQ家园啦，有可能聊天室也要用到这个。

那些未知的服务器，可能是用来发广告用的，猜想～

成功时

登录成功或者重定向时，核心层会触发QQ_LOGIN_SUCCESS事件，这个事件携带的包是LoginReplyPacket，用户应该检查replyCode的值，然后进行相应的操作：

当replyCode为QQ_LOGIN_REPLY_OK时，有以下字段可用：

sessionKey: byte[]，会话密钥

ip: byte[]，用户IP

port: int, 用户端口

serverIp: byte[], 服务器IP

serverPort: int, 服务器端口

loginTime: int, 本次登录时间

lastLoginTime: int, 上次登录时间

clientKey: byte[], Client Key

当replyCode为QQ_LOGIN_REPLY_REDIRECT时，有以下字段可用：

redirectIp: byte[], 重定向到的服务器IP

redirectPort: int, 重定向到的服务器端口

重定向到零地址时

在登录高峰期，登录重定向时有可能得到一个0地址，这时核心层会触发QQ_LOGIN_REDIRECT_NULL事件，这个事件携带的包是LoginReplyPacket，不过这个包没有什么可用信息。

密码错误时

如果密码错误，核心层会触发QQ_LOGIN_PASSWORD_ERROR事件，这个事件携带的包是LoginReplyPacket，可用的字段如下：

replyMessage: String, 错误信息字符串

未知错误时

如果回复码不是以上三种，则核心层会触发QQ_LOGIN_UNKNOWN_ERROR事件，这个事件携带的包是LoginReplyPacket，但是没有可用字段。

改变状态

登录之后的第一件事就是切换自己的状态，不然你发不出消息，这个一定要注意了，不是登录成功之后就能发消息，而是改变状态之后才能发消息。LumaQQ核心层自动处理登录后的状态改变，所以基本上你可以不管状态改变的事件，就看你的需要了。

请求包格式

头部

想要切换到的状态，1字节，定义如下

QQ_FRIEND_STATUS_ONLINE: 在线

QQ_FRIEND_STATUS_OFFLINE: 离线

QQ_FRIEND_STATUS_AWAY: 离开

QQ_FRIEND_STATUS_HIDDEN: 隐身

是否显示虚拟摄像头，4字节，最低位置1表示显示虚拟摄像头，其他位似乎无用